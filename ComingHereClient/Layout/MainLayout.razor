@using ComingHereClient.Services
@using ComingHereClient.Provider
@using ComingHereShared.Constants
@using ComingHereShared.DTO
@using System.Security.Claims
@inherits LayoutComponentBase
@inject HttpClient Http
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider
@inject CustomAuthStateProvider CustomAuthStateProvider
@inject AuthService AuthService
@inject IJSRuntime JS
@inject LocalizationService Loc

<div class="layout">
    <div class="top-bar">
        <div class="top-left">
            <div class="logo-img"></div>
        </div>

        <div class="top-center">
            @*<img src="@("pic/HeaderBackground.png")" />*@
        </div>

        <div class="top-right">
            <div class="greeting">
                @if (isAuthenticated)
                {
                    <span>@Loc["TopPanel_Hello"], @userEmail!</span>
                }
                else
                {
                    <span>@Loc["TopPanel_NotAuth"]</span>
                }
            </div>

            <div class="button-row">
                <button class="custom-btn" @onclick="ToggleTheme">@Loc["TopPanel_Theme"]</button>

                <div class="language-dropdown" id="langDropdown">
                    <button class="custom-btn" @onclick="ToggleLangMenu">@Loc["TopPanel_Language"]</button>
                    @if (langMenuVisible)
                    {
                        <ul class="lang-menu">
                            <li @onclick='() => ChangeLanguage("en")'>English</li>
                            <li @onclick='() => ChangeLanguage("uk")'>Українська</li>
                        </ul>
                    }
                </div>

                @if (isAuthenticated)
                {
                    <button class="custom-btn" @onclick="Logout">@Loc["TopPanel_Logout"]</button>
                }
                else
                {
                    <button class="custom-btn" @onclick='() => Nav.NavigateTo(ClientRoutes.Login)'>@Loc["TopPanel_Login"]</button>
                    <button class="custom-btn" @onclick='() => Nav.NavigateTo(ClientRoutes.Register)'>@Loc["TopPanel_Register"]</button>
                }
            </div>
        </div>
    </div>

    <div class="main-area">
        <div class="ch-sidebar-left">
            <LeftSidebar />
        </div>

        <main class="main-content">
            <article class="main-content-block">
                @Body
            </article>
        </main>

        <div class="ch-sidebar-right">
            <RightSidebar />
        </div>
    </div>
</div>

@code {
    private bool isAuthenticated = false;
    private string? userEmail;
    private bool langMenuVisible = false;
    private DotNetObjectReference<MainLayout>? dotNetRef;

    protected override async Task OnInitializedAsync()
    {
        AuthStateProvider.AuthenticationStateChanged += OnAuthStateChanged;
        await LoadUserInfoAsync();
    }

    private void OnAuthStateChanged(Task<AuthenticationState> task)
    {
        _ = InvokeAsync(async () =>
        {
            await LoadUserInfoAsync();
            StateHasChanged();
        });
    }

    private async Task LoadUserInfoAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated ?? false)
        {
            isAuthenticated = true;
            userEmail = user.FindFirst(c => c.Type == ClaimTypes.Email)?.Value
                        ?? user.Identity.Name
                        ?? "User";
        }
        else
        {
            isAuthenticated = false;
            userEmail = null;
        }
    }

    private async Task Logout()
    {
        await AuthService.Logout();

        // Сообщаем CustomAuthStateProvider, что пользователь вышел
        await CustomAuthStateProvider.MarkUserAsLoggedOut();

        isAuthenticated = false;
        userEmail = null;

        Nav.NavigateTo(ClientRoutes.Login, forceLoad: true);

        StateHasChanged();
    }

    private async Task ChangeLanguage(string culture)
    {
        await JS.InvokeVoidAsync("localStorage.setItem", "blazorCulture", culture);
        await JS.InvokeVoidAsync("location.reload");
    }

    private async Task ToggleTheme()
    {
        await JS.InvokeVoidAsync("toggleTheme");
    }

    private void ToggleLangMenu()
    {
        langMenuVisible = !langMenuVisible;

        if (langMenuVisible)
        {
            dotNetRef = DotNetObjectReference.Create(this);
            JS.InvokeVoidAsync("registerOutsideClickHandler", "langDropdown", dotNetRef);
        }
    }

    [JSInvokable]
    public void CloseLangMenu()
    {
        if (langMenuVisible)
        {
            langMenuVisible = false;
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        AuthStateProvider.AuthenticationStateChanged -= OnAuthStateChanged;
        dotNetRef?.Dispose();
    }
}