@using ComingHereShared.DTO.EventDtos
@code {
    [Parameter] public EventReviewDtoWithReplies Review { get; set; } = default!;
    [Parameter] public List<EventReviewDtoWithReplies> Replies { get; set; } = new();
    [Parameter] public EventCallback<(int parentId, string replyText)> OnReply { get; set; }

    private bool showReplyForm = false;
    private string replyText = "";

    private void TriggerReply()
    {
        showReplyForm = !showReplyForm;
        if (showReplyForm)
        {
            // вставляем ник в начало, если его там нет
            if (string.IsNullOrWhiteSpace(replyText) || !replyText.StartsWith($"@{Review.AuthorName}"))
            {
                replyText = $"@{Review.AuthorName}, ";
            }
        }
        else
        {
            replyText = "";
        }
    }

    private async Task SubmitReply()
    {
        if (string.IsNullOrWhiteSpace(replyText)) return;
        await OnReply.InvokeAsync((Review.Id, replyText));
        replyText = "";
        showReplyForm = false;
    }
}

<div class="mb-3 border-left ps-3" style="border-color: #ccc; border-width: 3px;">
    <strong>@Review.AuthorName</strong> — @Review.CreatedAt.ToLocalTime().ToString("g")<br />
    @if (Review.Rating > 0)
    {
        <span>Рейтинг: @Review.Rating / 5</span>
    
        <br />
    }
    <p>@Review.Comment</p>

    @if (!string.IsNullOrEmpty(Review.PhotoUrl))
    {
        <img src="@Review.PhotoUrl" alt="Фото к отзыву" style="max-width: 200px; border-radius: 4px;" />
    }

    <button class="btn btn-sm btn-link" @onclick="TriggerReply">
        @(showReplyForm ? "Отмена" : "Ответить")
    </button>

    @if (showReplyForm)
    {
        <div class="mt-2">
            <textarea class="form-control mb-2" @bind="replyText" rows="2"></textarea>
            <button class="btn btn-primary btn-sm" @onclick="SubmitReply">Отправить ответ</button>
        </div>
    }

    @if (Replies != null && Replies.Count > 0)
    {
        <div class="mt-3 ms-4">
            @foreach (var reply in Replies)
            {
                <ReviewWithReplies Review="reply"
                                   Replies="reply.Replies"
                                   OnReply="OnReply" />
            }
        </div>
    }
</div>